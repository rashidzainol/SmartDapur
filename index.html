<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SmartDapur</title>
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõí</text></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #FF5722;
            --primary-dark: #E64A19;
            --white: #ffffff;
            --bg-gray: #f5f5f5;
            --text: #212121;
            --text-light: #757575;
            --success: #4caf50;
            --danger: #f44336;
            --danger-bg: #ffebee;
            --info: #2196F3;
            --border: #e0e0e0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-gray);
            color: var(--text);
            /* FIX 1: Jarak bawah mengambil kira Safe Area (Navigation Bar) + Tinggi Footer */
            padding-bottom: calc(100px + env(safe-area-inset-bottom)); 
            /* FIX 2: Jarak atas mengambil kira Status Bar */
            padding-top: env(safe-area-inset-top);
        }

        /* --- HEADER --- */
        .app-header {
            background-color: var(--primary);
            color: white;
            padding: 10px 15px;
            /* FIX 3: Tambah padding atas untuk status bar jika transparent */
            padding-top: calc(10px + env(safe-area-inset-top));
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            height: auto;
            min-height: 60px;
        }

        .logo-container { display: flex; align-items: center; gap: 8px; }
        .logo-svg { height: 32px; width: auto; fill: white; }
        .logo-text { font-size: 18px; font-weight: 800; color: white; letter-spacing: -0.5px; }
        .header-actions button { background: none; border: none; font-size: 18px; color: white; }

        /* --- SCREENS --- */
        .screen { display: none; animation: fadeIn 0.3s ease; padding: 15px; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- HOME --- */
        .welcome-banner { background: white; border-radius: 10px; padding: 20px; text-align: center; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .welcome-banner h2 { color: var(--primary); margin-bottom: 5px; }
        .section-header { font-size: 14px; font-weight: 600; color: var(--text-light); margin: 20px 0 10px 0; text-transform: uppercase; }

        .shopping-list-card {
            background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); border-left: 4px solid var(--text-light);
        }
        .shopping-list-info h3 { font-size: 16px; margin-bottom: 4px; }
        .shopping-list-info p { font-size: 12px; color: var(--text-light); }
        .budget-status { font-weight: 700; font-size: 13px; margin-top: 5px; }
        .status-ok { color: var(--success); }
        .status-over { color: var(--danger); }
        .chevron { color: #ccc; }

        .fab {
            position: fixed; 
            /* FIX 4: Naikkan butang FAB supaya tak kena navigation bar */
            bottom: calc(25px + env(safe-area-inset-bottom)); 
            right: 25px; 
            width: 56px; height: 56px; background-color: var(--primary); color: white;
            border-radius: 50%; border: none; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; z-index: 90;
        }

        /* --- CART SCREEN --- */
        .cart-header-strip { background: white; padding: 10px 15px; display: flex; align-items: center; border-bottom: 1px solid #eee; }
        .back-btn { border: none; background: none; font-size: 16px; color: var(--text); margin-right: 10px; }
        .cart-title { font-weight: 600; font-size: 16px; flex: 1; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        
        .cart-stats-row {
            display: flex; gap: 10px; padding: 10px 15px; background: white; overflow-x: auto; white-space: nowrap; margin-bottom: 10px; box-shadow: 0 2px 3px rgba(0,0,0,0.05);
            -ms-overflow-style: none; scrollbar-width: none;
        }
        .cart-stats-row::-webkit-scrollbar { display: none; }
        .stat-bubble { flex: 1; padding: 8px 10px; border-radius: 10px; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 90px; }
        .stat-label { font-size: 10px; opacity: 0.9; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-value { font-size: 14px; font-weight: 800; }
        .bg-budget { background-color: var(--info); }
        .bg-spent { background-color: var(--primary); }
        .bg-safe { background-color: var(--success); }
        .bg-danger { background-color: var(--danger); }

        .add-product-container { background: white; padding: 15px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .search-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .input-group { flex: 1; position: relative; background: #f0f0f0; border-radius: 8px; display: flex; align-items: center; padding: 0 10px; }
        .input-group input { border: none; background: transparent; width: 100%; padding: 10px; font-size: 14px; }
        .input-group input:focus { outline: none; }
        .price-qty-row { display: flex; gap: 10px; }
        .mini-input { flex: 1; background: #f0f0f0; border: none; padding: 10px; border-radius: 8px; font-size: 14px; text-align: center; }
        .btn-add-cart { background: var(--primary); color: white; border: none; padding: 10px 15px; border-radius: 8px; font-weight: 600; width: 100%; margin-top: 5px; }

        .cart-item { background: white; margin-bottom: 2px; padding: 15px; display: flex; align-items: flex-start; position: relative; }
        .cart-item.bought { background: #fafafa; }
        .cart-item.bought .product-name { text-decoration: line-through; color: #999; }
        .cart-item.bought .product-img { opacity: 0.5; }

        .check-container { padding-top: 5px; margin-right: 10px; }
        .custom-check { width: 20px; height: 20px; border: 2px solid #ccc; border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .custom-check.checked { background: var(--success); border-color: var(--success); }
        .custom-check i { color: white; font-size: 12px; display: none; }
        .custom-check.checked i { display: block; }

        .img-area { position: relative; margin-right: 12px; }
        .product-img { width: 50px; height: 50px; background: #e0f7fa; color: #006064; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .history-btn-small {
            position: absolute; bottom: -5px; right: -5px;
            background: white; border: 1px solid #ddd; width: 20px; height: 20px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 10px; color: var(--primary);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer;
        }

        .product-details { flex: 1; }
        .product-name { font-weight: 600; font-size: 14px; margin-bottom: 4px; display: block; }
        .product-price { color: var(--primary); font-size: 13px; font-weight: 700; }
        .qty-adjuster { display: flex; align-items: center; border: 1px solid #ddd; border-radius: 4px; overflow: hidden; margin-top: 5px; width: fit-content; }
        .qty-btn { background: white; border: none; width: 25px; height: 25px; font-weight: bold; color: #555; }
        .qty-display { padding: 0 8px; font-size: 12px; font-weight: 600; border-left: 1px solid #ddd; border-right: 1px solid #ddd; background: #fafafa; }
        .delete-btn-mini { position: absolute; top: 15px; right: 15px; color: #ccc; border: none; background: none; font-size: 14px; }

        .cart-footer { 
            position: fixed; 
            bottom: 0; left: 0; width: 100%; 
            background: white; 
            padding: 12px 20px; 
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); 
            display: flex; justify-content: space-between; align-items: center; 
            z-index: 99; 
            /* FIX 5: Padding bawah untuk elak navigation bar overlay */
            padding-bottom: calc(12px + env(safe-area-inset-bottom));
        }
        
        .total-label { font-size: 12px; color: #777; display: block; }
        .total-amount { font-size: 18px; font-weight: 800; color: var(--primary); }
        .checkout-status { font-size: 12px; font-weight: 600; color: var(--success); text-align: right; }

        .delete-confirm-box { background: var(--danger-bg); padding: 10px; margin-top: 5px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; }
        .del-text { color: var(--danger); font-size: 12px; font-weight: 600; }
        .del-actions button { border: none; padding: 4px 10px; border-radius: 4px; font-size: 11px; margin-left: 5px; }
        .btn-confirm { background: var(--danger); color: white; }
        .btn-cancel { background: white; border: 1px solid #ccc !important; }

        /* MODALS */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; justify-content: center; align-items: flex-end; }
        .modal-content { 
            background: white; width: 100%; border-radius: 20px 20px 0 0; padding: 25px; max-height: 85vh; overflow-y: auto; animation: slideUp 0.3s ease; 
            /* FIX 6: Modal juga perlu padding bawah extra */
            padding-bottom: calc(40px + env(safe-area-inset-bottom));
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .close-btn { float: right; border: none; background: none; font-size: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { font-size: 12px; color: #777; display: block; margin-bottom: 5px; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; }
        
        .suggestions-list { position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 1px solid #ddd; border-top: none; z-index: 50; max-height: 150px; overflow-y: auto; border-radius: 0 0 8px 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none; }
        .suggest-item { padding: 10px; border-bottom: 1px solid #eee; font-size: 13px; }

        /* HISTORY MODAL SPECIFIC */
        .history-item { border-bottom: 1px solid #eee; padding: 10px 0; display: flex; justify-content: space-between; font-size: 13px; }
        .history-date { color: #777; font-size: 11px; }
        .history-price { font-weight: 600; color: var(--primary); }

        .brand-credit { text-align: center; margin-top: 30px; font-size: 12px; color: #aaa; padding-bottom: 20px;}
        .brand-credit span { color: var(--primary); font-weight: 600; }
    </style>
</head>
<body>

    <header class="app-header">
        <div class="logo-container">
            <svg class="logo-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                <path d="M192 128V96c0-17.7-14.3-32-32-32H96c-17.7 0-32 14.3-32 32v32H24C10.7 128 0 138.7 0 152v288c0 13.3 10.7 24 24 24h464c13.3 0 24-10.7 24-24V152c0-13.3-10.7-24-24-24h-40v-32c0-17.7-14.3-32-32-32h-64c-17.7 0-32 14.3-32 32v32H192zm224 0V96h64v32h-64zm-192 0V96h64v32h-64zM64 160h384v272H64V160z"/>
                <path d="M256 224c-26.5 0-48 21.5-48 48s21.5 48 48 48 48-21.5 48-48-21.5-48-48-48zm84.9-42.4c-46.9-46.9-122.9-46.9-169.7 0l16.9 16.9c37.5-37.5 98.3-37.5 135.8 0l16.9-16.9zm-42.4 42.4c-23.4-23.4-61.4-23.4-84.9 0l16.9 16.9c14.1-14.1 36.9-14.1 51 0l16.9-16.9z"/>
            </svg>
            <span class="logo-text">SmartDapur</span>
        </div>
        <div class="header-actions">
            <button id="settingsBtn"><i class="fas fa-cog"></i></button>
        </div>
    </header>

    <div id="homeScreen" class="screen active">
        <div class="welcome-banner">
            <h2>Daftar Belian</h2>
            <p style="color:#777; font-size:13px;">Pilih senarai atau buat baru</p>
        </div>
        <div class="section-header">Senarai Saya</div>
        <div id="listsContainer"></div>
        <div class="brand-credit">Powered by <span>RashidZainol</span></div>
        <button class="fab" id="newListBtn"><i class="fas fa-plus"></i></button>
    </div>

    <div id="cartScreen" class="screen" style="padding:0;">
        <div class="cart-header-strip">
            <button class="back-btn" id="backBtn"><i class="fas fa-arrow-left"></i></button>
            <div class="cart-title" id="currentListName">Nama Senarai</div>
        </div>
        
        <div class="cart-stats-row">
            <div class="stat-bubble bg-budget">
                <span class="stat-label">Bajet</span>
                <span class="stat-value" id="valBudget">RM 0</span>
            </div>
            <div class="stat-bubble bg-spent">
                <span class="stat-label">Belanja</span>
                <span class="stat-value" id="valSpent">RM 0</span>
            </div>
            <div class="stat-bubble bg-safe" id="bubbleBalance">
                <span class="stat-label">Baki</span>
                <span class="stat-value" id="valBalance">RM 0</span>
            </div>
        </div>

        <div class="add-product-container">
            <div class="search-row">
                <div class="input-group">
                    <i class="fas fa-search"></i>
                    <input type="text" id="itemName" placeholder="Cari / Tambah Produk..." autocomplete="off">
                    <div class="suggestions-list" id="suggestions"></div>
                </div>
            </div>
            <div class="price-qty-row">
                <input type="number" id="itemPrice" class="mini-input" placeholder="RM Harga" step="0.01">
                <input type="number" id="itemQuantity" class="mini-input" placeholder="Qty" value="1">
            </div>
            <button class="btn-add-cart" id="addItemBtn">Masukkan Ke Bakul</button>
        </div>
        <div id="cartItemsList" style="padding-bottom: 80px;"></div>
        <div class="cart-footer">
            <div>
                <span class="total-label">Jumlah Keseluruhan</span>
                <span class="total-amount" id="footerTotal">RM 0.00</span>
            </div>
            <div class="checkout-status" id="footerStatus">0/0 Item</div>
        </div>
    </div>

    <div class="modal" id="newListModal">
        <div class="modal-content">
            <button class="close-btn" id="closeNewListModal">&times;</button>
            <h3 style="margin-bottom:20px;">Buat Senarai Baru</h3>
            <div class="form-group"><label>Nama Senarai</label><input type="text" id="listName" placeholder="Contoh: Barang Dapur Bulanan"></div>
            <div class="form-group"><label>Tarikh</label><input type="date" id="listDate"></div>
            <div class="form-group"><label>Bajet (RM)</label><input type="number" id="listBudget" placeholder="0.00"></div>
            <div class="form-group"><label>Lokasi</label><select id="listLocation"></select></div>
            <button class="btn-add-cart" id="saveListBtn">Cipta Senarai</button>
        </div>
    </div>
    
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <button class="close-btn" id="closeHistoryModal">&times;</button>
            <h3 id="histTitle">Sejarah Harga</h3>
            <div id="historyListContainer" style="margin-top:15px;"></div>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <button class="close-btn" id="closeSettingsModal">&times;</button>
            <h3>Tetapan</h3>
            <div class="section-header">Urus Data</div>
            <div style="display:flex; gap:10px;">
                <button class="mini-input" id="exportJSONBtn">Backup</button>
                <button class="mini-input" id="importJSONBtn">Restore</button>
            </div>
            <div class="section-header">Lokasi / Supermarket</div>
            <div id="smListSetting"></div>
            <button class="mini-input" id="addSMBtn" style="width:100%; margin-top:10px;">+ Tambah Lokasi</button>
            <div class="brand-credit">Version 2.6 ‚Ä¢ <span>RashidZainol</span></div>
        </div>
    </div>
    <div class="modal" id="smModal">
        <div class="modal-content">
            <button class="close-btn" id="closeSMModal">&times;</button>
            <h3>Tambah Lokasi</h3>
            <div class="form-group"><label>Nama</label><input type="text" id="smName"></div>
            <div class="form-group"><label>Warna</label><input type="color" id="smColor" value="#ff5722" style="height:40px;"></div>
            <button class="btn-add-cart" id="saveSMBtn">Simpan</button>
        </div>
    </div>

    <input type="file" id="jsonFileInput" style="display:none;">

    <script>
        // --- DATA ---
        let shoppingLists = JSON.parse(localStorage.getItem('shoppingLists')) || [];
        let currentListId = null;
        let productDatabase = JSON.parse(localStorage.getItem('productDatabase')) || {};
        let supermarkets = JSON.parse(localStorage.getItem('supermarkets')) || [
            { id: 'aeon', name: 'Aeon', color: '#8E24AA' },
            { id: 'lotus', name: 'Lotus', color: '#43A047' },
            { id: 'mydin', name: 'Mydin', color: '#039BE5' },
            { id: 'others', name: 'Lain-lain', color: '#757575' }
        ];

        // --- INIT ---
        document.getElementById('listDate').valueAsDate = new Date();
        init();

        // --- NAVIGATION ---
        function showHome() {
            document.getElementById('cartScreen').classList.remove('active');
            document.getElementById('homeScreen').classList.add('active');
            currentListId = null;
            renderLists();
        }
        function showCart(id) {
            currentListId = id;
            document.getElementById('homeScreen').classList.remove('active');
            document.getElementById('cartScreen').classList.add('active');
            renderCart();
        }
        document.getElementById('backBtn').onclick = showHome;

        // --- HOME LOGIC ---
        function renderLists() {
            const container = document.getElementById('listsContainer');
            container.innerHTML = '';
            if(shoppingLists.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#ccc; margin-top:20px;">Tiada senarai.</p>';
                return;
            }
            shoppingLists.slice().reverse().forEach(list => {
                const sm = supermarkets.find(s => s.id === list.location) || {name:'Lain', color:'#777'};
                const div = document.createElement('div');
                div.className = 'shopping-list-card';
                div.style.borderLeftColor = sm.color;
                
                const total = list.items.filter(i => i.bought).reduce((acc, i) => acc + (i.price * i.quantity), 0);
                const isOverBudget = total > list.budget;
                const statusColor = isOverBudget ? 'status-over' : 'status-ok';

                div.innerHTML = `
                    <div class="shopping-list-info">
                        <h3>${list.name}</h3>
                        <p>${new Date(list.date).toLocaleDateString('ms-MY')} ‚Ä¢ <span style="color:${sm.color}; font-weight:600;">${sm.name}</span></p>
                        <p class="budget-status ${statusColor}">
                            Belanja: RM ${total.toFixed(2)} / RM ${list.budget.toFixed(2)}
                        </p>
                    </div>
                    <i class="fas fa-chevron-right chevron"></i>
                `;
                div.onclick = () => showCart(list.id);
                container.appendChild(div);
            });
        }

        // --- CART LOGIC ---
        function renderCart() {
            const list = shoppingLists.find(l => l.id === currentListId);
            if(!list) return showHome();
            document.getElementById('currentListName').textContent = list.name;
            
            const container = document.getElementById('cartItemsList');
            container.innerHTML = '';
            
            const sortedItems = [...list.items].sort((a,b) => (a.bought === b.bought) ? 0 : a.bought ? 1 : -1);
            
            if(sortedItems.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:40px; color:#ccc;"><i class="fas fa-shopping-basket" style="font-size:40px; margin-bottom:10px;"></i><br>Bakul kosong</div>';
            }
            
            let totalSpent = 0;
            let totalCount = list.items.length;
            let boughtCount = 0;
            
            sortedItems.forEach((item) => {
                const originalIndex = list.items.indexOf(item);
                if(item.bought) { totalSpent += (item.price * item.quantity); boughtCount++; }
                
                const el = document.createElement('div');
                if(item.isConfirmingDelete) {
                    el.className = 'cart-item';
                    el.innerHTML = `
                        <div style="width:100%;">
                            <div class="product-name">${item.name}</div>
                            <div class="delete-confirm-box">
                                <span class="del-text">Padam dari bakul?</span>
                                <div class="del-actions"><button class="btn-confirm" onclick="confirmDel(${originalIndex})">Ya</button><button class="btn-cancel" onclick="cancelDel(${originalIndex})">Batal</button></div>
                            </div>
                        </div>`;
                } else {
                    el.className = `cart-item ${item.bought ? 'bought' : ''}`;
                    el.innerHTML = `
                        <div class="check-container"><div class="custom-check ${item.bought ? 'checked' : ''}" onclick="toggleCheck(${originalIndex})"><i class="fas fa-check"></i></div></div>
                        <div class="img-area">
                            <div class="product-img"><i class="fas fa-${getItemIcon(item.name)}"></i></div>
                            <div class="history-btn-small" onclick="event.stopPropagation(); showHist('${item.name}')"><i class="fas fa-history"></i></div>
                        </div>
                        <div class="product-details">
                            <span class="product-name">${item.name}</span>
                            <span class="product-price">RM ${(item.price * item.quantity).toFixed(2)}</span>
                            <div class="qty-adjuster" onclick="event.stopPropagation()"><button class="qty-btn" onclick="updateQty(${originalIndex}, -1)">-</button><span class="qty-display">${item.quantity}</span><button class="qty-btn" onclick="updateQty(${originalIndex}, 1)">+</button></div>
                        </div>
                        <button class="delete-btn-mini" onclick="askDel(${originalIndex})"><i class="fas fa-trash"></i></button>`;
                }
                container.appendChild(el);
            });
            
            const remaining = list.budget - totalSpent;
            document.getElementById('valBudget').textContent = `RM ${list.budget.toFixed(2)}`;
            document.getElementById('valSpent').textContent = `RM ${totalSpent.toFixed(2)}`;
            document.getElementById('valBalance').textContent = `RM ${remaining.toFixed(2)}`;
            const bubbleBalance = document.getElementById('bubbleBalance');
            if (remaining < 0) { bubbleBalance.className = 'stat-bubble bg-danger'; } else { bubbleBalance.className = 'stat-bubble bg-safe'; }

            document.getElementById('footerTotal').textContent = `RM ${totalSpent.toFixed(2)}`;
            document.getElementById('footerStatus').textContent = `${boughtCount}/${totalCount} Selesai`;
            document.getElementById('footerStatus').style.color = (boughtCount === totalCount && totalCount > 0) ? 'var(--success)' : '#777';
        }

        function getItemIcon(name) {
            name = name.toLowerCase();
            if(name.includes('ayam') || name.includes('daging')) return 'drumstick-bite';
            if(name.includes('ikan')) return 'fish';
            if(name.includes('sayur') || name.includes('salad')) return 'carrot';
            if(name.includes('roti')) return 'bread-slice';
            if(name.includes('susu') || name.includes('air')) return 'bottle-water';
            if(name.includes('sabun')) return 'pump-soap';
            if(name.includes('epal') || name.includes('buah')) return 'apple-alt';
            return 'box-open';
        }

        document.getElementById('addItemBtn').onclick = () => {
            const name = document.getElementById('itemName').value.trim();
            const price = parseFloat(document.getElementById('itemPrice').value);
            const qty = parseInt(document.getElementById('itemQuantity').value);
            if(!name || isNaN(price) || isNaN(qty) || qty < 1) return alert('Isi maklumat produk');
            const list = shoppingLists.find(l => l.id === currentListId);
            const existIdx = list.items.findIndex(i => i.name.toLowerCase() === name.toLowerCase());
            if(existIdx !== -1) { list.items[existIdx].quantity += qty; list.items[existIdx].price = price; list.items[existIdx].bought = false; }
            else { list.items.push({name, price, quantity:qty, bought:false}); }
            updateDB(name, price, list.location); save(); renderCart();
            document.getElementById('itemName').value = ''; document.getElementById('itemPrice').value = ''; document.getElementById('itemQuantity').value = 1; document.getElementById('suggestions').style.display = 'none';
        }

        window.toggleCheck = (idx) => { const list = shoppingLists.find(l => l.id === currentListId); list.items[idx].bought = !list.items[idx].bought; save(); renderCart(); }
        window.updateQty = (idx, change) => { const list = shoppingLists.find(l => l.id === currentListId); const item = list.items[idx]; const newQty = item.quantity + change; if(newQty <= 0) { item.isConfirmingDelete = true; } else { item.quantity = newQty; item.isConfirmingDelete = false; if(change > 0) item.bought = false; } save(); renderCart(); }
        window.askDel = (idx) => { const list = shoppingLists.find(l => l.id === currentListId); list.items[idx].isConfirmingDelete = true; renderCart(); }
        window.confirmDel = (idx) => { const list = shoppingLists.find(l => l.id === currentListId); list.items.splice(idx, 1); save(); renderCart(); }
        window.cancelDel = (idx) => { const list = shoppingLists.find(l => l.id === currentListId); list.items[idx].isConfirmingDelete = false; if(list.items[idx].quantity <= 0) list.items[idx].quantity = 1; renderCart(); }

        // --- HISTORY FUNCTION ---
        const histModal = document.getElementById('historyModal');
        const closeHist = document.getElementById('closeHistoryModal');
        closeHist.onclick = () => histModal.style.display = 'none';

        window.showHist = (name) => {
            const data = productDatabase[name];
            const container = document.getElementById('historyListContainer');
            container.innerHTML = '';
            document.getElementById('histTitle').innerText = `Sejarah: ${name}`;

            if(!data || !data.prices || data.prices.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#999;">Tiada rekod harga.</p>';
            } else {
                // Sort date descending
                const sorted = [...data.prices].sort((a,b) => new Date(b.date) - new Date(a.date));
                sorted.slice(0, 10).forEach(p => {
                    const sm = supermarkets.find(s => s.id === p.location) || {name: 'Lain'};
                    container.innerHTML += `
                        <div class="history-item">
                            <div>
                                <span style="display:block;">${sm.name}</span>
                                <span class="history-date">${new Date(p.date).toLocaleDateString('ms-MY')}</span>
                            </div>
                            <div class="history-price">RM ${p.price.toFixed(2)}</div>
                        </div>
                    `;
                });
            }
            histModal.style.display = 'flex';
        }

        const sInput = document.getElementById('itemName'); const sList = document.getElementById('suggestions');
        sInput.oninput = () => {
            const val = sInput.value.toLowerCase().trim(); sList.innerHTML = ''; if(val.length < 2) return sList.style.display = 'none';
            const matches = Object.keys(productDatabase).filter(k => k.toLowerCase().includes(val)).slice(0,5);
            if(matches.length === 0) return sList.style.display = 'none';
            matches.forEach(k => {
                const data = productDatabase[k]; const lastPrice = data.prices.sort((a,b)=>new Date(b.date)-new Date(a.date))[0].price;
                const div = document.createElement('div'); div.className = 'suggest-item'; div.innerHTML = `${data.name} <span style="float:right; color:var(--primary);">RM ${lastPrice.toFixed(2)}</span>`;
                div.onclick = () => { sInput.value = data.name; document.getElementById('itemPrice').value = lastPrice.toFixed(2); sList.style.display = 'none'; };
                sList.appendChild(div);
            }); sList.style.display = 'block';
        }
        document.onclick = (e) => { if(!e.target.closest('.input-group')) sList.style.display = 'none'; }

        function updateDB(name, price, loc) { if(!productDatabase[name]) productDatabase[name] = {name, prices:[]}; productDatabase[name].prices.push({price, date:new Date(), location:loc}); localStorage.setItem('productDatabase', JSON.stringify(productDatabase)); }

        const newListModal = document.getElementById('newListModal');
        document.getElementById('newListBtn').onclick = () => { updateLocSelect(); newListModal.style.display = 'flex'; }
        document.getElementById('closeNewListModal').onclick = () => newListModal.style.display = 'none';
        document.getElementById('saveListBtn').onclick = () => { const name = document.getElementById('listName').value; const budget = parseFloat(document.getElementById('listBudget').value); const loc = document.getElementById('listLocation').value; const date = document.getElementById('listDate').value; if(!name || isNaN(budget)) return; shoppingLists.push({id:Date.now().toString(), name, budget, location:loc, date, items:[]}); save(); showHome(); newListModal.style.display = 'none'; }

        const setModal = document.getElementById('settingsModal');
        document.getElementById('settingsBtn').onclick = () => { renderSMSetting(); setModal.style.display = 'flex'; }
        document.getElementById('closeSettingsModal').onclick = () => setModal.style.display = 'none';
        function renderSMSetting() { const div = document.getElementById('smListSetting'); div.innerHTML = ''; supermarkets.forEach((s, i) => { if(s.id === 'others') return; div.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;"><span><b style="color:${s.color}">‚óè</b> ${s.name}</span><button onclick="delSM(${i})" style="color:red; border:none; background:none;">X</button></div>`; }); }
        window.delSM = (i) => { if(confirm('Padam?')) { supermarkets.splice(i, 1); save(); renderSMSetting(); } }

        const smModal = document.getElementById('smModal');
        document.getElementById('addSMBtn').onclick = () => smModal.style.display = 'flex';
        document.getElementById('closeSMModal').onclick = () => smModal.style.display = 'none';
        document.getElementById('saveSMBtn').onclick = () => { const name = document.getElementById('smName').value; const color = document.getElementById('smColor').value; if(!name) return; supermarkets.push({id:name.toLowerCase().replace(/\s/g,''), name, color}); save(); smModal.style.display = 'none'; renderSMSetting(); }

        function updateLocSelect() { const s = document.getElementById('listLocation'); s.innerHTML = ''; supermarkets.forEach(sm => s.innerHTML += `<option value="${sm.id}">${sm.name}</option>`); }
        function save() { localStorage.setItem('shoppingLists', JSON.stringify(shoppingLists)); localStorage.setItem('supermarkets', JSON.stringify(supermarkets)); }
        
        document.getElementById('exportJSONBtn').onclick = () => { const blob = new Blob([JSON.stringify({shoppingLists, supermarkets, productDatabase})], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'smartdapur.json'; a.click(); }
        document.getElementById('importJSONBtn').onclick = () => document.getElementById('jsonFileInput').click();
        document.getElementById('jsonFileInput').onchange = (e) => { const r = new FileReader(); r.onload = (ev) => { const d = JSON.parse(ev.target.result); if(confirm('Restore data?')) { shoppingLists = d.shoppingLists; supermarkets = d.supermarkets; productDatabase = d.productDatabase; save(); location.reload(); } }; r.readAsText(e.target.files[0]); }
        function init() { updateLocSelect(); renderLists(); }
    </script>
</body>
</html>
